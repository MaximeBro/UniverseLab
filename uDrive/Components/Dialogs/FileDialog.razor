<EditForm Model="@_model" OnValidSubmit="@Submit">
    <DataAnnotationsValidator/>
    <MudDialog Class="background-800 dialog-full pa-2">
        <DialogContent>
            <MudStack Row="false" Spacing="0">
                <DialogCloseButton Dialog="@Dialog" Class="absolute align-self-end pa-1" Style="border-radius: 6px;"/>
                <MudText Class="ml-1" Align="Align.Left" Typo="Typo.h6">Création d'un fichier</MudText>
            </MudStack>

            <MudStack Class="px-12 py-4" Justify="Justify.SpaceEvenly" Row="false" Spacing="0">
                <MudFocusTrap DefaultFocus="DefaultFocus.FirstChild">
                    <MudTextField T="string" @bind-Value="_model.Name" Variant="Variant.Outlined" Label="Nom du répertoire" Class="input-text" Immediate/>
                </MudFocusTrap>
                <ValidationMessage For="@(() => _model.Name)"/>
                @if (DisplayError)
                {
                    <MudText>Ce fichier existe déjà.</MudText>
                }
            </MudStack>
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="@Close" Color="Color.Default">Annuler</MudButton>
            <MudButton ButtonType="ButtonType.Submit" Color="Color.Success" Disabled="@DisplayError">
                Ok
            </MudButton>
        </DialogActions>
    </MudDialog>
</EditForm>

@code {
    [CascadingParameter] public MudDialogInstance Dialog { get; set; } = null!;
    
    [Parameter] public string UserIdentifier { get; set; } = null!;
    [Inject] public IDbContextFactory<MainDbContext> Factory { get; set; } = null!;
    [Inject] public ISnackbar Snackbar { get; set; } = null!;
    
    private readonly FileModel _model = new();
    private string[] _forbiddenNames = [];

    private bool DisplayError => _forbiddenNames.Contains(_model.Name, StringComparer.OrdinalIgnoreCase);
    
    protected override async Task OnInitializedAsync()
    {
        await using var db = await Factory.CreateDbContextAsync();
        _forbiddenNames = db.UserFiles.Where(x => x.UserIdentifier == UserIdentifier).Select(x => x.FileName).ToArray();
    }

    private void Close() => Dialog.Close();
    private void Submit() => Dialog.Close(_model.Name);
}